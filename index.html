<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CollabPad.exe</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* RETRO THEME CSS */
        :root { --win-teal: #008080; --win-gray: #c0c0c0; --win-blue: #000080; --win-text: #000000; --win-light: #ffffff; --win-shadow: #808080; --win-dark: #000000; }
        body { margin: 0; padding: 0; background-color: var(--win-teal); font-family: 'Courier Prime', monospace; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; background-image: radial-gradient(var(--win-light) 1px, transparent 1px); background-size: 20px 20px; }
        
        /* COMMON WINDOW STYLES */
        .window { background: var(--win-gray); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); box-shadow: 4px 4px 0px rgba(0,0,0,0.5); display: flex; flex-direction: column; padding: 3px; }
        .title-bar { background: linear-gradient(90deg, var(--win-blue), #1084d0); padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: bold; font-family: sans-serif; letter-spacing: 1px; }
        .win-btn { background: var(--win-gray); border: 1px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); box-shadow: 1px 1px 0px black; padding: 2px 10px; text-align: center; font-weight: bold; font-family: sans-serif; font-size: 12px; cursor: pointer; }
        .win-btn:active { border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); box-shadow: none; transform: translate(1px, 1px); }

        /* MAIN APP WINDOW */
        .app-window { width: 900px; height: 85vh; }
        .menu-bar { display: flex; gap: 15px; padding: 5px 10px; border-bottom: 1px solid var(--win-shadow); margin-bottom: 5px; font-family: sans-serif; font-size: 14px; }
        .toolbar { display: flex; gap: 10px; padding: 5px 10px; border-bottom: 1px solid var(--win-shadow); align-items: center; }
        .tool-input { background: white; border: 2px solid; border-color: var(--win-shadow) var(--win-light) var(--win-light) var(--win-shadow); padding: 4px; font-family: 'Courier Prime', monospace; width: 200px; font-size: 14px; }
        .editor-container { flex-grow: 1; margin: 10px; position: relative; background: white; border: 2px solid; border-color: var(--win-shadow) var(--win-light) var(--win-light) var(--win-shadow); overflow: hidden; cursor: text; }
        #cursor-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        #editor { width: 100%; height: 100%; border: none; outline: none; padding: 10px; font-family: 'Courier Prime', monospace; font-size: 16px; line-height: 24px; resize: none; white-space: pre-wrap; word-wrap: break-word; background: transparent; z-index: 2; position: relative; color: black; }
        .status-bar { border-top: 1px solid var(--win-shadow); padding: 4px 10px; font-family: sans-serif; font-size: 12px; display: flex; justify-content: space-between; background: var(--win-gray); box-shadow: inset 1px 1px 0px var(--win-light); }
        .status-panel { border: 1px solid; border-color: var(--win-shadow) var(--win-light) var(--win-light) var(--win-shadow); padding: 2px 8px; min-width: 100px; }

        /* CURSORS */
        .remote-cursor { position: absolute; width: 2px; height: 24px; background: blue; }
        .flag { position: absolute; top: -18px; left: 0; background: var(--win-gray); border: 1px solid black; font-size: 10px; color: black; padding: 2px 4px; white-space: nowrap; font-family: sans-serif; box-shadow: 2px 2px 0px rgba(0,0,0,0.2); font-weight: bold; }

        /* LOGIN OVERLAY */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 128, 128, 0.5); z-index: 999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .login-box { width: 300px; padding: 4px; }
        .login-content { padding: 20px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .login-icon { font-size: 40px; color: var(--win-blue); }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="window login-box">
        <div class="title-bar">
            <span>Login.exe</span>
            <button class="win-btn">X</button>
        </div>
        <div class="login-content">
            <span class="material-icons login-icon">account_circle</span>
            <div style="font-family: sans-serif; font-size: 12px; text-align: center;">Welcome to CollabPad Network.<br>Please identify yourself.</div>
            <input type="text" id="username-input" class="tool-input" placeholder="Enter Username..." autofocus>
            <button class="win-btn" onclick="submitLogin()" style="width: 100%;">CONNECT</button>
        </div>
    </div>
</div>

<div class="window app-window">
    <div class="title-bar">
        <div style="display:flex; gap:8px;"><span class="material-icons" style="font-size: 16px;">edit_note</span> CollabPad.exe</div>
        <div style="display:flex; gap:4px;">
            <button class="win-btn">_</button><button class="win-btn">â–¡</button><button class="win-btn" onclick="window.close()">X</button>
        </div>
    </div>
    <div class="menu-bar"><span><u>F</u>ile</span><span><u>E</u>dit</span><span><u>S</u>earch</span><span><u>H</u>elp</span></div>
    <div class="toolbar">
        <span style="font-family: sans-serif; font-size:12px;">Filename:</span>
        <input type="text" id="doc-title" class="tool-input" value="Untitled.txt">
        <div style="flex-grow:1"></div>
        <button class="win-btn" onclick="downloadTxt()">SAVE</button>
        <button class="win-btn" onclick="copyToClipboard()">COPY</button>
        <button class="win-btn" onclick="clearDoc()">CLEAR</button>
    </div>
    <div class="editor-container">
        <div id="cursor-layer"></div>
        <textarea id="editor" spellcheck="false"></textarea>
    </div>
    <div class="status-bar">
        <div class="status-panel" id="status-badge">Waiting for Login...</div>
        <div class="status-panel" id="char-count">0 chars</div>
    </div>
</div>

<script>
    // --- SETUP ---
    let SITE_ID, USER_COLOR;
    let counter = 0;
    let crdtState = [];
    
    // UI Refs
    const editor = document.getElementById('editor');
    const titleInput = document.getElementById('doc-title');
    const statusBadge = document.getElementById('status-badge');
    const charCountEl = document.getElementById('char-count');
    const cursorLayer = document.getElementById('cursor-layer');
    const loginOverlay = document.getElementById('login-overlay');
    const usernameInput = document.getElementById('username-input');

    // Network Logic
    let wsUrl = 'ws://localhost:8080'; 
    if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        wsUrl = `${protocol}//${window.location.host}`;
    }
    const ws = new WebSocket(wsUrl);

    // Font Math
    let CHAR_WIDTH = 0; const LINE_HEIGHT = 24; 
    const canvas = document.createElement("canvas"); const ctx = canvas.getContext("2d"); ctx.font = "16px 'Courier Prime'"; CHAR_WIDTH = ctx.measureText("M").width;

    // --- LOGIN LOGIC ---
    function submitLogin() {
        const name = usernameInput.value.trim();
        if (name) {
            // Send name to server
            ws.send(JSON.stringify({ type: 'join', name: name }));
            // Remove overlay
            loginOverlay.style.display = 'none';
            statusBadge.innerText = "Logged in as " + name;
            editor.focus();
        } else {
            alert("Please enter a name!");
        }
    }
    // Allow 'Enter' key to login
    usernameInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') submitLogin();
    });

    // --- NETWORK HANDLERS ---
    ws.onopen = () => { statusBadge.innerText = "Connected. Please Login."; };
    ws.onclose = () => { statusBadge.innerText = "Disconnected"; };

    ws.onmessage = async (event) => {
        let textData = event.data instanceof Blob ? await event.data.text() : event.data;
        const msg = JSON.parse(textData);
        
        if (msg.type === 'init') {
            if (msg.self) { SITE_ID = msg.self.userId; USER_COLOR = msg.self.color; }
            if (msg.title) { titleInput.value = msg.title; } 
            if (msg.snapshot) crdtState = msg.snapshot;
            renderText();
        } 
        else if (msg.type === 'operation') { applyOp(msg.data); renderText(); } 
        else if (msg.type === 'cursor') { renderRemoteCursor(msg); }
        else if (msg.type === 'title') { titleInput.value = msg.title; }
    };

    // --- CRDT LOGIC ---
    function generateId() { counter++; return `${counter}@${SITE_ID}`; }
    function findRealIndex(visualIndex) {
        let seen = 0;
        for (let i = 0; i < crdtState.length; i++) {
            if (!crdtState[i].tombstone) {
                if (seen === visualIndex) return i;
                seen++;
            }
        }
        return -1;
    }
    function localInsert(char, visualIndex) {
        let origin = null;
        if (visualIndex > 0) {
            const realPrevIndex = findRealIndex(visualIndex - 1);
            if (realPrevIndex !== -1) origin = crdtState[realPrevIndex].id;
        }
        const charObj = { char, id: generateId(), origin, tombstone: false };
        integrateInsert(charObj);
        renderText();
        ws.send(JSON.stringify({ type: 'operation', data: { op: 'insert', charObj } }));
    }
    function localDelete(visualIndex) {
        const realIndex = findRealIndex(visualIndex);
        if (realIndex !== -1 && crdtState[realIndex]) {
            const charObj = crdtState[realIndex];
            charObj.tombstone = true;
            renderText();
            ws.send(JSON.stringify({ type: 'operation', data: { op: 'delete', id: charObj.id } }));
        }
    }
    function integrateInsert(charObj) {
        let destIdx = -1;
        if (charObj.origin) destIdx = crdtState.findIndex(c => c.id === charObj.origin);
        let finalIdx = destIdx + 1;
        while (finalIdx < crdtState.length) {
            const next = crdtState[finalIdx];
            if (next.origin !== charObj.origin) break;
            if (next.id < charObj.id) break;
            finalIdx++;
        }
        crdtState.splice(finalIdx, 0, charObj);
    }
    function integrateDelete(id) {
        const target = crdtState.find(c => c.id === id);
        if (target) target.tombstone = true;
    }
    function applyOp(data) {
        if (data.op === 'insert') {
            if (!crdtState.find(c => c.id === data.charObj.id)) integrateInsert(data.charObj);
        } else if (data.op === 'delete') integrateDelete(data.id);
    }
    function renderText() {
        const text = crdtState.filter(c => !c.tombstone).map(c => c.char).join('');
        if (editor.value !== text) {
            const saveCursor = editor.selectionStart;
            editor.value = text;
            editor.setSelectionRange(saveCursor, saveCursor);
            lastValue = text;
        }
        updateStats(text);
    }

    // --- INPUT ---
    let lastValue = "";
    editor.addEventListener('input', (e) => {
        const newValue = e.target.value;
        if (newValue.length > lastValue.length) {
            let i = 0; while (i < lastValue.length && lastValue[i] === newValue[i]) i++;
            localInsert(newValue[i], i);
        } else if (newValue.length < lastValue.length) {
            let i = 0; while (i < newValue.length && newValue[i] === lastValue[i]) i++;
            localDelete(i);
        }
        lastValue = newValue;
    });

    // --- UI/EVENTS ---
    titleInput.addEventListener('input', () => { if(ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'title', title: titleInput.value })); });
    ['keyup', 'click', 'input'].forEach(evt => { editor.addEventListener(evt, () => { if (ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'cursor', index: editor.selectionStart })); }); });

    function updateStats(text) { charCountEl.innerText = `${text.length} chars`; }
    function downloadTxt() { const blob = new Blob([editor.value], { type: "text/plain" }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = titleInput.value + ".txt"; a.click(); }
    function copyToClipboard() { editor.select(); document.execCommand('copy'); }
    function clearDoc() { if(confirm("Clear Document?")) location.reload(); }

    function renderRemoteCursor(msg) {
        const existing = document.getElementById(`cursor-${msg.userId}`);
        if (existing) existing.remove();
        const index = Math.min(msg.index, editor.value.length);
        const textUpToCursor = editor.value.substring(0, index);
        const lines = textUpToCursor.split('\n');
        const row = lines.length - 1;
        const col = lines[lines.length - 1].length;
        const top = row * LINE_HEIGHT;
        const left = col * CHAR_WIDTH;
        const cursor = document.createElement('div');
        cursor.id = `cursor-${msg.userId}`;
        cursor.className = 'remote-cursor';
        cursor.style.backgroundColor = msg.color;
        cursor.style.top = `${top}px`;
        cursor.style.left = `${left}px`;
        
        const flag = document.createElement('div');
        flag.className = 'flag';
        // USE THE USERNAME IF AVAILABLE
        flag.innerText = msg.username || `User ${msg.userId}`;
        flag.style.backgroundColor = 'var(--win-gray)'; 
        cursor.appendChild(flag);
        cursorLayer.appendChild(cursor);
    }
</script>
</body>
</html>
